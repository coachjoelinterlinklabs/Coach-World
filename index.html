<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CJ Game DApp â€” Coach Joel House</title>

<!-- Load ethers correctly BEFORE game code -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  :root{--bg:#071324;--card:#0f1b26;--accent:#00c48c;--muted:#9aa4b2}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#02101a 0%,#071324 100%);color:#e6eef6;-webkit-tap-highlight-color:transparent}
  .wrap{max-width:960px;margin:8px auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  h1{margin:0;font-size:18px}
  .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;margin-top:12px}
  .row{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);color:#04121a;padding:10px 12px;border-radius:10px;border:0;font-weight:700}
  canvas{background:#081a22;border-radius:8px;display:block;width:100%;height:auto}
  .small{color:var(--muted);font-size:13px}
  .status{margin-top:8px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .controls{display:flex;justify-content:center;gap:8px;margin-top:8px}
  .touch-btn{background:rgba(255,255,255,0.03);color:#e6eef6;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:700}
  .screenshot{width:100%;border-radius:8px;margin-top:8px}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  @media(min-width:720px){ .grid{grid-template-columns:1fr 320px} }
</style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>CJ Game â€” Coach Joel House</h1>
        <div class="small">Mobile-friendly DApp â€” play, beat levels, claim 21 CJ per level.</div>
      </div>
    </header>

    <div class="card grid">
      <main>
        <section>
          <div class="flex-between">
            <div class="row">
              <button id="connectBtn">Connect Wallet</button>
              <div style="margin-left:8px">
                <div id="account" class="small">Not connected</div>
                <div id="cjBalance" class="small">$CJ Balance: -</div>
              </div>
            </div>
            <div class="small">Reward: <strong>21 CJ/level</strong></div>
          </div>

          <canvas id="gameCanvas" width="800" height="360"></canvas>

          <div class="status small">Level: <span id="level">1</span> â€” Score: <span id="score">0</span> â€” Lives: <span id="lives">3</span></div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="startBtn">Start Game</button>
            <button id="claimBtn" disabled>Claim Reward (0 CJ)</button>
            <button id="claimAllBtn" disabled>Claim All (multi-tx)</button>
            <button id="pauseBtn">Pause</button>
          </div>

          <div class="controls">
            <button class="touch-btn" id="leftBtn">â—€</button>
            <button class="touch-btn" id="jumpBtn">â–²</button>
            <button class="touch-btn" id="rightBtn">â–¶</button>
          </div>

          <h3 style="margin-top:12px">Transfer Rewards System</h3>
          <ol class="small">
            <li>Connect with ITLX Wallet or MetaMask.</li>
            <li>Each completed level gives **21 CJ pending**.</li>
            <li>Claim Reward â†’ calls your reward contract <code>claim()</code>.</li>
            <li>Claim All â†’ multiple claim calls (separate gas).</li>
          </ol>
        </section>
      </main>
    </div>

    <footer>
      <div class="small">Optimized for ITLX Wallet DApp browser.</div>
    </footer>
  </div>

<script>
// ============ CONFIG ============
const CJ_TOKEN_ADDRESS = "0x9ECEfef5d5B5b0aCF2467393e7b5A6c7c501c6F6";
const CLAIM_CONTRACT_ADDRESS = "0x2fAac87db2C3389674F8bF72E557e1C22134De49";

const ERC20_ABI = [
  { "constant":true, "inputs":[{"name":"_owner","type":"address"}], "name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
  { "constant":true, "inputs":[], "name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
];

const CLAIM_CONTRACT_ABI = [
  { "inputs": [], "name": "claim", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
];

// ============ WALLET CONNECT ============
let provider, signer, account;

async function connectWallet(){
  try {
    if (window.ethereum) {
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      account = await signer.getAddress();
      document.getElementById("account").innerText = account;
      loadBalance();
    } else {
      alert("No Web3 wallet found. Please open in ITLX Wallet.");
    }
  } catch(e) {
    console.error(e);
    alert("Connection failed.");
  }
}

async function loadBalance(){
  try{
    const token = new ethers.Contract(CJ_TOKEN_ADDRESS, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const raw = await token.balanceOf(account);
    document.getElementById("cjBalance").innerText = "CJ Balance: " + ethers.utils.formatUnits(raw, decimals);
  } catch(e){ console.error(e); }
}

document.getElementById("connectBtn").addEventListener("click", connectWallet);

// ============ CLAIM SYSTEM ============
let pendingReward = 0;

function updateClaimButtons(){
  document.getElementById("claimBtn").innerText = `Claim Reward (${pendingReward} CJ)`;
  document.getElementById("claimBtn").disabled = pendingReward < 21;

  const multi = Math.floor(pendingReward / 21);
  document.getElementById("claimAllBtn").innerText = `Claim All (${multi})`;
  document.getElementById("claimAllBtn").disabled = multi <= 0;
}

async function claimSingle(){
  if(!signer) return alert("Connect wallet first.");

  const contract = new ethers.Contract(CLAIM_CONTRACT_ADDRESS, CLAIM_CONTRACT_ABI, signer);

  try{
    const tx = await contract.claim();
    await tx.wait();
    alert("21 CJ claimed!");

    pendingReward -= 21;
    if (pendingReward < 0) pendingReward = 0;
    updateClaimButtons();
    loadBalance();

  }catch(e){ alert("Claim failed."); console.error(e); }
}

async function claimAll(){
  if(!signer) return alert("Connect wallet first.");

  const times = Math.floor(pendingReward / 21);
  if(times <= 0) return;

  const contract = new ethers.Contract(CLAIM_CONTRACT_ADDRESS, CLAIM_CONTRACT_ABI, signer);

  for(let i=0;i<times;i++){
    const tx = await contract.claim();
    await tx.wait();
    pendingReward -= 21;
    updateClaimButtons();
  }

  alert("All rewards claimed!");
  loadBalance();
}

document.getElementById("claimBtn").addEventListener("click", claimSingle);
document.getElementById("claimAllBtn").addEventListener("click", claimAll);

// ============ SIMPLE GAME ENGINE ============
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const w = Math.min(window.innerWidth - 24, 900);
  canvas.width = w;
  canvas.height = Math.floor(w * 0.45);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let running=false, level=1, score=0, lives=3;
const player={x:60,y:0,w:28,h:28,vy:0};
player.ground=()=>canvas.height-40;

let obstacles=[], enemies=[];
const goalX=()=>canvas.width-40;

function resetLevel(){ obstacles=[]; enemies=[]; player.x=60; player.y=player.ground(); player.vy=0; }

function spawnObstacles(){
  for(let i=0;i<level+2;i++){
    const ox=canvas.width*0.5 + i*(80 + Math.random()*60);
    obstacles.push({x:ox,y:player.ground(),w:30,h:30});
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#081a22"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#052025"; ctx.fillRect(0,canvas.height-40,canvas.width,40);

  ctx.fillStyle="#00c48c"; ctx.fillRect(player.x,player.y-player.h,player.w,player.h);

  ctx.fillStyle="#fff"; ctx.fillText("ðŸƒ",player.x+4,player.y-player.h/2+6);
  ctx.fillStyle="#d95555"; obstacles.forEach(o=>{ ctx.fillRect(o.x,o.y-o.h,o.w,o.h); });

  ctx.fillStyle="#fff"; ctx.fillText("ðŸ",goalX(),player.ground()-20);
}

function updatePhysics(dt){
  player.vy += 0.9;
  player.y += player.vy;
  if(player.y > player.ground()){ player.y = player.ground(); player.vy = 0; }

  obstacles.forEach(o=>o.x -= 2 + level*0.2);
}

function check(){
  for(let o of obstacles){
    if(player.x+player.w > o.x && player.x < o.x+o.w && player.y-player.h < o.y && player.y > o.y-o.h){
      lives--; document.getElementById("lives").innerText=lives; resetLevel();
      if(lives<=0){ running=false; alert("Game Over!"); }
      return;
    }
  }

  if(player.x > goalX()-10){
    level++; document.getElementById("level").innerText=level;

    // reward player 21 CJ
    pendingReward += 21;
    updateClaimButtons();

    resetLevel(); spawnObstacles();
  }
}

let lastT=0;
function loop(t){
  if(!running) return;
  updatePhysics(t-lastT); draw(); check();
  lastT=t; requestAnimationFrame(loop);
}

document.getElementById("startBtn").addEventListener("click", ()=>{
  if(!running){ running=true; level=1; score=0; lives=3; pendingReward=0;
    document.getElementById("lives").innerText=lives;
    updateClaimButtons();
    resetLevel(); spawnObstacles();
    lastT=performance.now(); requestAnimationFrame(loop);
  }
});

document.getElementById("pauseBtn").addEventListener("click", ()=>{
  running = !running;
  if(running){ lastT = performance.now(); requestAnimationFrame(loop); }
});

document.getElementById("leftBtn").addEventListener("touchstart", ()=>{ player.x -= 10; });
document.getElementById("rightBtn").addEventListener("touchstart", ()=>{ player.x += 10; });
document.getElementById("jumpBtn").addEventListener("touchstart", ()=>{ if(player.y==player.ground()) player.vy = -14; });

</script>
</body>
</html>
